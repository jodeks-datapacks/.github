name: Publish Datapack to Modrinth
on:
  workflow_call:
    secrets:
      MODRINTH_TOKEN:
        required: true
      DISCORD_WEBHOOK_URL:
        required: true

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Read modrinth.json
        id: meta
        run: |
          echo "project_id=$(jq -r '.project_id' modrinth.json)" >> $GITHUB_OUTPUT
          echo "loaders=$(jq -r '.loaders | join("\n")' modrinth.json)" >> $GITHUB_OUTPUT
          echo 'game_versions<<EOF' >> $GITHUB_OUTPUT
          jq -r '.game_versions[]' modrinth.json >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT
          echo "dependencies=$(jq -r '.dependencies // ""' modrinth.json)" >> $GITHUB_OUTPUT
          echo "version_type=$(jq -r '.version_type // "release"' modrinth.json)" >> $GITHUB_OUTPUT
          
      - name: Zip datapack
        run: |
          zip -r "${{ github.event.repository.name }}-${{ github.event.release.tag_name }}.zip" . \
            -x ".git/*" \
            -x ".github/*" \
            -x "modrinth.json"
      
      - name: Publish to Modrinth
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ steps.meta.outputs.project_id }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          files: "*.zip"
          name: ${{ github.event.repository.name }} ${{ github.event.release.tag_name }}
          version: ${{ github.event.release.tag_name }}
          version-type: ${{ steps.meta.outputs.version_type }}
          changelog: ${{ github.event.release.body }}
          loaders: ${{ steps.meta.outputs.loaders }}
          game-versions: ${{ steps.meta.outputs.game_versions }}
          dependencies: ${{ steps.meta.outputs.dependencies }}
      
      - name: Notify Discord
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          NAME="${{ github.event.repository.name }}"
          PROJECT_ID="${{ steps.meta.outputs.project_id }}"
          MC_VERSIONS=$(echo "${{ steps.meta.outputs.game_versions }}" | tr '\n' ', ' | sed 's/, $//')
          RELEASE_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          CHANGELOG=$(echo "${{ github.event.release.body }}" | jq -Rs .)
          ROLE_ID="${{ steps.meta.outputs.discord_role_id }}"
          PAYLOAD=$(cat <<EOF
          {
            "content": "<@&${ROLE_ID}> **${NAME} ${VERSION}** has just been released!",
            "embeds": [{
              "title": "${NAME} ${VERSION}",
              "url": "https://modrinth.com/datapack/${PROJECT_ID}",
              "color": 2303781,
              "fields": [
                {
                  "name": "Minecraft Versions",
                  "value": "${MC_VERSIONS}",
                  "inline": true
                },
                {
                  "name": "Release Date",
                  "value": "${RELEASE_DATE}",
                  "inline": true
                },
                {
                  "name": "Changelog",
                  "value": ${CHANGELOG}
                }
              ],
              "footer": {
                "text": "Automatically published via GitHub Actions"
              },
              "thumbnail": {
                "url": "https://cdn.modrinth.com/data/${PROJECT_ID}/icon.png"
              }
            }]
          }
          EOF
          )
          curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK_URL"
      
