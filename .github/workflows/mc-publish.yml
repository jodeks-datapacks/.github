name: Publish Datapack
on:
  workflow_call:
    secrets:
      MODRINTH_TOKEN:
        required: true
      CURSEFORGE_TOKEN:
        required: true
      DISCORD_WEBHOOK_URL:
        required: true
jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Read publish.json
        id: meta
        run: |
          echo "project_id=$(jq -r '.project_id' publish.json)" >> $GITHUB_OUTPUT
          echo "curseforge_project_id=$(jq -r '.curseforge_project_id // ""' publish.json)" >> $GITHUB_OUTPUT
          echo "curseforge_slug=$(jq -r '.curseforge_slug // ""' publish.json)" >> $GITHUB_OUTPUT
          echo "loaders=$(jq -r '.loaders | join("\n")' publish.json)" >> $GITHUB_OUTPUT
          echo 'game_versions<<EOF' >> $GITHUB_OUTPUT
          jq -r '.game_versions[]' publish.json >> $GITHUB_OUTPUT
          echo 'EOF' >> $GITHUB_OUTPUT
          echo "dependencies=$(jq -r '.dependencies // ""' publish.json)" >> $GITHUB_OUTPUT
          echo "version_type=$(jq -r '.version_type // "release"' publish.json)" >> $GITHUB_OUTPUT
          echo "discord_role_id=$(jq -r '.discord_role_id // ""' publish.json)" >> $GITHUB_OUTPUT
          
      - name: Zip datapack
        run: |
          zip -r "${{ github.event.repository.name }}-${{ github.event.release.tag_name }}.zip" . \
            -x ".git/*" \
            -x ".github/*" \
            -x "publish.json"
      
      - name: Publish to Modrinth & CurseForge
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ steps.meta.outputs.project_id }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}
          curseforge-id: ${{ steps.meta.outputs.curseforge_project_id }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}
          files: "*.zip"
          name: ${{ github.event.repository.name }} ${{ github.event.release.tag_name }}
          version: ${{ github.event.release.tag_name }}
          version-type: ${{ steps.meta.outputs.version_type }}
          changelog: ${{ github.event.release.body }}
          loaders: ${{ steps.meta.outputs.loaders }}
          game-versions: ${{ steps.meta.outputs.game_versions }}
          dependencies: ${{ steps.meta.outputs.dependencies }}
      
      - name: Get project icon
        id: icon
        run: |
          ICON_URL=$(curl -s "https://api.modrinth.com/v2/project/${{ steps.meta.outputs.project_id }}" | jq -r '.icon_url // ""')
          echo "url=${ICON_URL}" >> $GITHUB_OUTPUT
      
      - name: Notify Discord
        if: success()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          VERSION="${{ github.event.release.tag_name }}"
          NAME="${{ github.event.repository.name }}"
          PROJECT_ID="${{ steps.meta.outputs.project_id }}"
          CF_SLUG="${{ steps.meta.outputs.curseforge_slug }}"
          MC_VERSIONS_RAW=$(echo "${{ steps.meta.outputs.game_versions }}" | sort -V)
          MC_FIRST=$(echo "$MC_VERSIONS_RAW" | head -n1)
          MC_LAST=$(echo "$MC_VERSIONS_RAW" | tail -n1)
          if [ "$MC_FIRST" = "$MC_LAST" ]; then
            MC_VERSIONS="$MC_FIRST"
          else
            MC_VERSIONS="${MC_FIRST} - ${MC_LAST}"
          fi
          CHANGELOG=$(echo "${{ github.event.release.body }}" | jq -Rs . | sed 's/^"//;s/"$//')
          ROLE_ID="${{ steps.meta.outputs.discord_role_id }}"
          ICON_URL="${{ steps.icon.outputs.url }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          
          PAYLOAD=$(cat <<EOF
          {
            "content": "<@&${ROLE_ID}>",
            "embeds": [{
              "title": "${NAME} ${VERSION}",
              "description": "A new version has been released!",
              "url": "https://modrinth.com/datapack/${PROJECT_ID}/version/${VERSION}",
              "color": 2293637,
              "fields": [
                {
                  "name": "Changelog",
                  "value": "${CHANGELOG}",
                  "inline": false
                },
                {
                  "name": "Minecraft Versions",
                  "value": "\`${MC_VERSIONS}\`",
                  "inline": false
                },
                {
                  "name": "Downloads",
                  "value": "[Modrinth](https://modrinth.com/datapack/${PROJECT_ID}/version/${VERSION}) â€¢ [CurseForge](https://www.curseforge.com/minecraft/data-packs/${CF_SLUG})",
                  "inline": false
                }
              ],
              "thumbnail": {
                "url": "${ICON_URL}"
              },
              "footer": {
                "text": "Published to Modrinth & CurseForge"
              },
              "timestamp": "${TIMESTAMP}"
            }]
          }
          EOF
          )
          curl -H "Content-Type: application/json" -d "$PAYLOAD" "$DISCORD_WEBHOOK_URL"
